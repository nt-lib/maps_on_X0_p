load "divisors.m";

P := ProjectiveSpace(Rationals(),2);
R<x,y,z> := PolynomialRing(Rationals(),3);
S := CuspForms(Gamma0(197));
g := Dimension(S);
forms := [S.i : i in [g-2..g]];
n := Valuation(qExpansion(forms[1],2*g))-1;

// we start by finding a singular planar model of X0(197) by
// finding a homogeneous polynomial of degree d vanishing on 3 cusp forms of weight 2
// for the above choice of 3 cusp forms the smallest d such that such a polynomial exists
// is 17. This value was obtained experimentally by increasing d.
// in order to speed up the computation we hardcoded d = 17
d := 17;
prec := 400;
expanded_forms := [qExpansion(f, prec) : f in forms];
monomials := MonomialsOfDegree(R,d);
evals := [Evaluate(mon, expanded_forms) : mon in monomials];
prec1 := Minimum([Degree(f) : f in evals]);
val := Minimum([Valuation(f) : f in evals]); 
// prec is the starting precision, prec1 is the precision that we have after evaluating
// the monomials at the one forms, prec1 is higher since our one forms have a bunch of
// leading zero's, and it is the relative precision that is important for multiplication.
// the assertion is to assure that we have enough precision, note that the d-th tensor power
// of the canonical bundle has degree 2g-2. So one would expect (2*g-2)*d to be enough
// precision. However we need (2*g-1)*d, since we are not working with q expansions of
// differential forms, but with q expansions of weight 2 modular forms. And we multiply by 
// dq/q to get the invariant differential form.
assert prec1 gt (2*g-1)*d;
M := Matrix(Rationals(),[[Coefficient(f,i) : i in [val..prec1]] : f in evals]);

// this assertion is to check that d is the correct value
assert Rank(M) eq #monomials - 1;
rels := Basis(Kernel(M));
assert #rels eq 1;
v := ClearDenominator(rels[1])[1];
equation := &+[monomials[i]*v[i] : i in [1..#monomials]];

// C is a singular planar model for X_0(p) although strictly speaking it could
// be another curve which has a dominant map from X_0(p) to it. We will check 
// that it is indeed X_0(p) by computing its geometric genus mod p.
C := Curve(P, equation);
// we work over F_3 since this particular model doesn't behave nice
// over F_2, indeed the defining equation is reducible mod 2.
p := 3;
Cp := ChangeRing(C,GF(p));
assert Genus(Cp) eq g;
// the above assertion guarantees that the reduction of our equation
// mod 3 is indeed a model of X_0(p)_{F_3}, and hence that our characteristic 0
// model is also a model of X_0(p)_Q

K<q> := Parent(evals[1]);
/* sage code
# the curve E is taken from https://www.lmfdb.org/EllipticCurve/Q/197/a/1
E = EllipticCurve([0, 0, 1, -5, 4])
phi = E.modular_parametrization()
phi.power_series(500)
*/
// the x and y are based on the output of the sage code above. We could probably
// get away with less precision
x := (1/q)^2 + 2*(1/q) + 3 + 3*q + 3*q^2 - 2*q^3 - q^4 + 2*q^5 - 3*q^6 + 5*q^7 + 17*q^8 + 3*q^9 + 2*q^10 + 12*q^11 - 20*q^12 - 26*q^13 + 19*q^14 + 6*q^15 + 72*q^17 + 37*q^18 - 61*q^19 - 2*q^20 - 4*q^21 - 126*q^22 + 33*q^23 + 216*q^24 + 15*q^25 + 36*q^26 + 246*q^27 - 208*q^28 - 445*q^29 + 197*q^30 + 58*q^31 - 313*q^32 + 830*q^33 + 812*q^34 - 874*q^35 - 67*q^36 + 517*q^37 - 2030*q^38 - 598*q^39 + 2916*q^40 - 229*q^41 - 681*q^42 + 4357*q^43 - 1288*q^44 - 6792*q^45 + 2710*q^46 + 1373*q^47 - 7716*q^48 + 7966*q^49 + 12984*q^50 - 11164*q^51 - 1766*q^52 + 13624*q^53 - 23571*q^54 - 17444*q^55 + 35777*q^56 - 1554*q^57 - 23733*q^58 + 57316*q^59 + 8601*q^60 - 90765*q^61 + 27876*q^62 + 43117*q^63 - 122139*q^64 + 47396*q^65 + 192182*q^66 - 128012*q^67 - 67008*q^68 + 245914*q^69 - 217546*q^70 - 327456*q^71 + 423300*q^72 + 53280*q^73 - 476354*q^74 + 638010*q^75 + 403612*q^76 - 1133410*q^77 + 190307*q^78 + 899074*q^79 - 1562918*q^80 - 106099*q^81 + 2588385*q^82 - 1239839*q^83 - 1558278*q^84 + 3507704*q^85 - 1346819*q^86 - 5056924*q^87 + 4550703*q^88 + 2129726*q^89 - 7452715*q^90 + 5747078*q^91 + 8216473*q^92 - 13153308*q^93 - 777840*q^94 + 15099800*q^95 - 16919270*q^96 - 9693344*q^97 + 32403915*q^98 - 8643920*q^99 - 28480932*q^100 + 42883429*q^101 + 1832271*q^102 - 69743052*q^103 + 42706413*q^104 + 47024934*q^105 - 99745630*q^106 + 35566123*q^107 + 131182622*q^108 - 139389693*q^109 - 56448577*q^110 + 217449242*q^111 - 150778796*q^112 - 208424592*q^113 + 374612651*q^114 - 2138792*q^115 - 442395205*q^116 + 452915488*q^117 + 243708009*q^118 - 878831516*q^119 + 305282731*q^120 + 817920811*q^121 - 1175158095*q^122 - 42626146*q^123 + 1833509246*q^124 - 1296117158*q^125 - 1285735762*q^126 + 2781016248*q^127 - 928179861*q^128 - 3387621266*q^129 + 3949952566*q^130 + 1372687010*q^131 - 6090589487*q^132 + 3988343113*q^133 + 5343013236*q^134 - 10170538954*q^135 + 623486202*q^136 + 12269754221*q^137 - 12165123920*q^138 - 6241239834*q^139 + 23210291139*q^140 - 9472313920*q^141 - 22136851486*q^142 + 31904472396*q^143 + 1016685211*q^144 - 47623776284*q^145 + 36699414249*q^146 + 33323207068*q^147 - 75725161689*q^148 + 24567781900*q^149 + 87238927559*q^150 - 107137016436*q^151 - 31894545746*q^152 + 164890969812*q^153 - 106144777169*q^154 - 137071748282*q^155 + 268821480572*q^156 - 28539532569*q^157 - 327505580745*q^158 + 325336557040*q^159 + 159188818610*q^160 - 603749978607*q^161 + 273046181545*q^162 + 577629816116*q^163 - 853640420410*q^164 - 19829807096*q^165 + 1227140184825*q^166 - 997444894554*q^167 - 838261299575*q^168 + 2016559588565*q^169 - 659363467712*q^170 - 2235327897999*q^171 + 2832185433420*q^172 + 723795620424*q^173 - 4348676020946*q^174 + 2823716865077*q^175 + 3493648018241*q^176 - 6991489136708*q^177 + 990756489387*q^178 + 8515197556766*q^179 - 8619299051212*q^180 - 3998254626920*q^181 + 15544805172065*q^182 - 7532427214204*q^183 - 14728904614664*q^184 + 22489067103102*q^185 + 217609724854*q^186 - 31387226744428*q^187 + 26439625166412*q^188 + 20726757395206*q^189 - 52700306883786*q^190 + 17793057758503*q^191 + 56857541774917*q^192 - 73672609391722*q^193 - 16199759054292*q^194 + 112469324232564*q^195 - 74683160272292*q^196 - 88147332852295*q^197 + 179850895001056*q^198 - 30629478660512*q^199 - 217423262889619*q^200 + 225795135103172*q^201 + 98584734855907*q^202 - 396925894906109*q^203 + 202237613033078*q^204 + 369957254541354*q^205 - 584154901027430*q^206 + 4408839880135*q^207 + 796747676565241*q^208 - 689691554632738*q^209 - 506973450054961*q^210 + 1356676132645252*q^211 - 478965447876827*q^212 - 1434015256874406*q^213 + 1895350626612175*q^214 + 358340499666470*q^215 - 2866981310846031*q^216 + 1958482663487146*q^217 + 2199691855533538*q^218 - 4587366932489250*q^219 + 891359325122818*q^220 + 5480871633899264*q^221 - 5849741852339479*q^222 - 2388237511002319*q^223 + 10059550154345269*q^224 - 5335869315407391*q^225 - 9195639482550645*q^226 + 14992265549538084*q^227 - 404081555146675*q^228 - 20071863956881100*q^229 + 17792880964129892*q^230 + 12303419807922710*q^231 - 34514842023543797*q^232 + 12800586872589091*q^233 + 35859872361054163*q^234 - 48352675426997894*q^235 - 7813474232747807*q^236 + 72292239903509342*q^237 - 50888503110219614*q^238 - 54326180417459991*q^239 + 116162129512996502*q^240 - 25039691103372922*q^241 - 136858631824908384*q^242 + 150049527467075062*q^243 + 56959839518368835*q^244 - 253172072432516458*q^245 + 139104134643801659*q^246 + 226761370985603818*q^247 - 380986272742821549*q^248 + 18052111261342894*q^249 + 501988443593243634*q^250 - 455213521422945129*q^251 - 296598804977635516*q^252 + 869947976585776766*q^253 - 339001589057634130*q^254 - 889618375644160344*q^255 + 1224965944580907339*q^256 + 167002854046459631*q^257 - 1807600223210075018*q^258 + 1310763888866917015*q^259 + 1329455081353350500*q^260 - 2922471665998019607*q^261 + 687633301097382590*q^262 + 3392132896805636634*q^263 - 3816103112868125182*q^264 - 1340228316404414184*q^265 + 6330623981161618277*q^266 - 3594177107744341080*q^267 - 5555580912122413573*q^268 + 9603646809355726608*q^269 - 653950876765721984*q^270 - 12470629416905716128*q^271 + 11567257389404596178*q^272 + 7105446347397964788*q^273 - 21764073538712398330*q^274 + 8895026913300564092*q^275 + 21913245424916534686*q^276 - 30844954658164243906*q^277 - 3469985994722941508*q^278 + 44892676106250881778*q^279 - 33499521620805786895*q^280 - 32277982065155921938*q^281 + 73094657394195964585*q^282 - 18583734200747795984*q^283 - 83563699771808156307*q^284 + 96353874159862346038*q^285 + 31159167491786212133*q^286 - 157368930631668479851*q^287 + 92202413023823051012*q^288 + 135339737159233992831*q^289 - 240471099589522627151*q^290 + 21324417994039883514*q^291 + 307941694786543221299*q^292 - 292214555029886035349*q^293 - 169179689498887658504*q^294 + 541155441261948602318*q^295 - 231394533801341908397*q^296 - 536413688465871645076*q^297 + 772468470356516198539*q^298 + 69214336053930531478*q^299 - 1108661093508325881023*q^300 + 850360419841571944907*q^301 + 778374108433286695942*q^302 - 1818499519750459361036*q^303 + 496087063131575853628*q^304 + 2047762840971595206020*q^305 - 2418058076954213696374*q^306 - 716462494510763814764*q^307 + 3891255882447248529039*q^308 - 2350863470243190997350*q^309 - 3280166569868003404400*q^310 + 5987644915957105557801*q^311 - 652341688242948972095*q^312 - 7563641628754531968959*q^313 + 7343708758622629709411*q^314 + 4003800058042656533452*q^315 - 13386038684990127581329*q^316 + 5973456828799127943638*q^317 + 13059558456712707696467*q^318 - 19250758756597406590630*q^319 - 1296779249540564735873*q^320 + 27246738301122023834120*q^321 - 21459465762090680831357*q^322 - 18659595182652906140532*q^323 + 45025875621334936016435*q^324 - 13109377487964620548352*q^325 - 49948620103446044337849*q^326 + 60367010149801241425552*q^327 + 16298133921861685458597*q^328 - 95764646027257520860411*q^329 + 59616165710128084698789*q^330 + 79126739600400707572563*q^331 - 148376926694347081789646*q^332 + 19118359012178339375917*q^333 + 184903924903549123293776*q^334 - 183695110733187302812966*q^335 - 94188961947411273662869*q^336 + 329635078569878621857004*q^337 - 153169398118369180123425*q^338 - 316433993280398218630918*q^339 + 477632587749674861321013*q^340 + 21792536319711477252652*q^341 - 666768372654512757244389*q^342 + 538794354691799365078259*q^343 + 444976026070867705138175*q^344 - 1110056442907146242610662*q^345 + 343423545339165687805994*q^346 + 1213256478405927429410494*q^347 - 1500273820430480313227428*q^348 - 366698835538681252479566*q^349 + 2346869086855078066564299*q^350 - 1504483246332388861820520*q^351 - 1900470607398929188888853*q^352 + 3661511480823181563228983*q^353 - 543348703046513974926616*q^354 - 4501400565515607544437104*q^355 + 4575540575649024545721618*q^356 + 2202770896670113010187478*q^357 - 8085301825469085820877115*q^358 + 3904373033466272171588134*q^359 + 7634832334369481794576231*q^360 - 11803405831496536043420648*q^361 - 286930341423287782155249*q^362 + 16254617562845213443624248*q^363 - 13467547537363870225811893*q^364 - 10560959669401436570930828*q^365 + 27261730088296096833818354*q^366 - 8928104205896914715306446*q^367 - 29358498278500709574882761*q^368 + 37137795407754996237772913*q^369 + 8153829967863084213726102*q^370 - 57297598530991814102369614*q^371 + 37800130013404304655230119*q^372 + 45461666863814970637537546*q^373 - 90021342283565985911658832*q^374 + 15089352556931618696558848*q^375 + 109177141665115041083248414*q^376 - 113532923767856337918357590*q^377 - 51216443059342222651794630*q^378 + 197616115279940042793968132*q^379 - 99006684972095767356893374*q^380 - 183512742153920185905543760*q^381 + 290640766105929022891933304*q^382 + 977780884860484195052666*q^383 - 394893690178935483109661908*q^384 + 335300958569698376658449620*q^385 + 249548935326156206455264328*q^386 - 667199690746417239293095271*q^387 + 230533627730728805362855155*q^388 + 707961042965256316438092094*q^389 - 916061344026242269690357964*q^390 - 178932818407755681920490554*q^391 + 1394168987772368912113180498*q^392 - 945917103453440186783999098*q^393 - 1083419069462979240601853701*q^394 + 2205909883374087258522462868*q^395 - 411553694935579873396218087*q^396 - 2639132238255486950941912848*q^397 + 2807300794042635643220691622*q^398 + 1183936377020059898989288334*q^399 - 4814605299179557795834058767*q^400 + 2498957461712023936729937015*q^401 + 4395763011814327295077438058*q^402 - 7133297925478033629387565546*q^403 + 122972218689172772723277481*q^404 + 9563581002023885456203879314*q^405 - 8318393975742702206001899427*q^406 - 5872234880019582488904011992*q^407 + 16277903303141164756520984390*q^408 - 5916449396427266815582529667*q^409 - 17017768325603028755194041761*q^410 + 22524159652566503113712054300*q^411 + 3866946272474022098044179818*q^412 - 33819557845462582515963338844*q^413 + 23584074191807887422762522492*q^414 + 25728840315671847807064462912*q^415 - 53891988399515917211233512994*q^416 + 11063034255670700495389465864*q^417 + 63602043526768959467309962274*q^418 - 69195757797298163120565120247*q^419 - 27208433125779349201951845866*q^420 + 116959791482082971494508674444*q^421 - 62811271461619288270038769071*q^422 - 104960431394924856417260965227*q^423 + 174557668233619120557863090930*q^424 - 6550299994948902176178361938*q^425 - 230947926494602818977207783312*q^426 + 205706801038039583486953391849*q^427 + 137633431217090094088396165837*q^428 - 396010737314963313462143168706*q^429 + 151009029065523120204564275418*q^430 + 407869488773261846011394690865*q^431 - 552223840645651613695279454299*q^432 - 82037504979332999774315987863*q^433 + 818114793021398975654768549282*q^434 - 586038175996187216494654617822*q^435 - 608986095828437816240996639723*q^436 + 1313017150859631608877568232519*q^437 - 293843178861841965755596504663*q^438 - 1528531181365624164539490794646*q^439 + 1700641763737445026673792225576*q^440 + 621546440346202494006483648600*q^441 - 2833724125519729802827160932796*q^442 + 1572786126379864820412158427507*q^443 + 2498849194138439587360102019427*q^444 - 4260055618560425967638045477512*q^445 + 245018477762994207683522471000*q^446 + 5562394187077963513147078705742*q^447 - 5072063545661882359196480599830*q^448 - 3213436421983063969355505940753*q^449 + 9609243881234734591553167700791*q^450 - 3835198400883535117646067000170*q^451 - 9748975720005775960155449129825*q^452 + 13503048561327226861360313743150*q^453 + 1700284823017260579519625384365*q^454 - 19740433007697233398633952003034*q^455 + 14517583857424477035532780363058*q^456 + 14369258777161749099581041103369*q^457 - 31909912075241660034751729542778*q^458 + 7726299652442161511869691504586*q^459 + 36640888752332094095034539418845*q^460 - 41686340903254815554087963931278*q^461 - 14110133270375712621912432145628*q^462 + 68488389113789672573917304948462*q^463 - 39246217626389472819924214951857*q^464 - 59328082506812446717894733109038*q^465 + 103709237134844022455991203187632*q^466 - 8009523976541201525964254866586*q^467 - 133644706992028229441732613909864*q^468 + 124724565766101449163100985496488*q^469 + 74743350687105450227579097178939*q^470 - 232615210840867890755765920749344*q^471 + 96964911187838414736598280935370*q^472 + 232432806094870610893175048265916*q^473 - 329375536672631159282283039952283*q^474 - 34163294005248665909637187218783*q^475 + 475206986908571814543478573338556*q^476 - 358616504143421107952793316306122*q^477 - 338036842952078581801977061117155*q^478 + 773706260416192978501824820875282*q^479 - 201405670570570282164983634679824*q^480 - 876248416300389458195940018261634*q^481 + 1019328012717095919307013441060491*q^482 + 318210255936579562388611802717660*q^483 - 1651567410412348805511916185513826*q^484 + 976212524664714708654499822823934*q^485 + 1404933039405532256577822221098683*q^486 - 2519014629382497408043986029584901*q^487 + 243566302149544194194548707752267*q^488 + 3203768898511592171631932041926466*q^489 - 3059433303149876220112718159388482*q^490 - 1731992734047201739880184300381121*q^491 + 5618676606129559967643937658519376*q^492 - 2441498254191560966942198035459058*q^493 - 5528498316957349097334488743025965*q^494 + 8016310116888386702917217522910270*q^495 + 656800815627631486005240279943194*q^496 - 11414800090869105262943077708280260*q^497 + O(q^498);
y:= -(1/q)^3 - 3*(1/q)^2 - 6*(1/q) - 9 - 8*q - 7*q^2 - 2*q^3 + 8*q^4 - 13*q^6 - 12*q^7 - 45*q^8 - 62*q^9 + 3*q^10 + 8*q^11 - q^12 + 112*q^13 + 39*q^14 - 171*q^15 - 73*q^16 - 112*q^17 - 351*q^18 + 93*q^19 + 450*q^20 - 44*q^21 + 157*q^22 + 411*q^23 - 1017*q^24 - 1232*q^25 + 329*q^26 - 450*q^27 - 480*q^28 + 2912*q^29 + 1486*q^30 - 2701*q^31 + 154*q^32 - 744*q^33 - 7781*q^34 - 21*q^35 + 8630*q^36 - 1973*q^37 + 2256*q^38 + 14751*q^39 - 11940*q^40 - 22872*q^41 + 10488*q^42 - 7169*q^43 - 24764*q^44 + 47118*q^45 + 38751*q^46 - 47941*q^47 + 16398*q^48 + 27971*q^49 - 135307*q^50 - 32511*q^51 + 149390*q^52 - 59476*q^53 - 20390*q^54 + 302040*q^55 - 97002*q^56 - 383416*q^57 + 220249*q^58 - 30147*q^59 - 590864*q^60 + 567035*q^61 + 755569*q^62 - 792831*q^63 + 197830*q^64 + 1001628*q^65 - 1865133*q^66 - 1037962*q^67 + 2403442*q^68 - 897143*q^69 - 1519416*q^70 + 4788454*q^71 + 121526*q^72 - 6207177*q^73 + 3478487*q^74 + 1832899*q^75 - 10655853*q^76 + 5010045*q^77 + 13306158*q^78 - 11991958*q^79 - 677811*q^80 + 21214629*q^81 - 21506646*q^82 - 22701728*q^83 + 35959310*q^84 - 7456257*q^85 - 38725354*q^86 + 63749502*q^87 + 24321507*q^88 - 94382692*q^89 + 41240043*q^90 + 63590280*q^91 - 159042855*q^92 + 16507847*q^93 + 215152759*q^94 - 155844072*q^95 - 84463572*q^96 + 354797110*q^97 - 192928556*q^98 - 417659700*q^99 + 488605742*q^100 + 38464626*q^101 - 727253871*q^102 + 719541500*q^103 + 642194766*q^104 - 1333855590*q^105 + 306566689*q^106 + 1370739873*q^107 - 2050158097*q^108 - 558511328*q^109 + 3213309714*q^110 - 1659548746*q^111 - 2296262973*q^112 + 5077172233*q^113 - 892997981*q^114 - 6815785176*q^115 + 5878390432*q^116 + 2987104448*q^117 - 11433800535*q^118 + 6487936935*q^119 + 12414963427*q^120 - 17225412955*q^121 - 966535490*q^122 + 23743453339*q^123 - 22730874815*q^124 - 17845117983*q^125 + 44190450297*q^126 - 12113088190*q^127 - 45035989077*q^128 + 63686412961*q^129 + 12960970905*q^130 - 100951211556*q^131 + 59683200181*q^132 + 74527172217*q^133 - 157629610160*q^134 + 33695465116*q^135 + 204739246005*q^136 - 199247060493*q^137 - 91884376977*q^138 + 356318712548*q^139 - 204582020118*q^140 - 358544370250*q^141 + 555766366289*q^142 + 10721834582*q^143 - 740395265754*q^144 + 694813019910*q^145 + 492763943742*q^146 - 1367846495360*q^147 + 439383151493*q^148 + 1392447959016*q^149 - 1930338691140*q^150 - 305562078757*q^151 + 3019102787085*q^152 - 1977132156751*q^153 - 2248652344962*q^154 + 4767089502822*q^155 - 1127323300024*q^156 - 5950987738939*q^157 + 6292370677984*q^158 + 2594372686983*q^159 - 10746767139876*q^160 + 6230563606044*q^161 + 10158414749675*q^162 - 16938030207868*q^163 + 336674634618*q^164 + 22170161422462*q^165 - 20755487821318*q^166 - 13513169105181*q^167 + 40522400230429*q^168 - 14763820931430*q^169 - 41081049673326*q^170 + 57227967014702*q^171 + 7162696456598*q^172 - 87413940581956*q^173 + 61733640581871*q^174 + 64509221282622*q^175 - 140551391174156*q^176 + 35759021440464*q^177 + 169030888387423*q^178 - 189373683252841*q^179 - 69316621805227*q^180 + 314584183601579*q^181 - 185504119923543*q^182 - 283248601148591*q^183 + 496745109899955*q^184 - 28212345147987*q^185 - 641915161092156*q^186 + 607965807679894*q^187 + 366382312877893*q^188 - 1164922414338440*q^189 + 467732610889071*q^190 + 1169754665785288*q^191 - 1661322699417268*q^192 - 161785568422774*q^193 + 2472707646939557*q^194 - 1847413337365136*q^195 - 1786362445364657*q^196 + 4047352741777738*q^197 - 1101243198727702*q^198 - 4714102039701844*q^199 + 5509528538264772*q^200 + 1783792127356613*q^201 - 8973576194459730*q^202 + 5423114984569689*q^203 + 7778388394002035*q^204 - 14176414090015911*q^205 + 1276223401858117*q^206 + 18090295191719708*q^207 - 17487403131703126*q^208 - 9786697058110077*q^209 + 32757971470733028*q^210 - 14188125915141758*q^211 - 32426582397850157*q^212 + 47292585274964682*q^213 + 3390871138047729*q^214 - 68681961932781024*q^215 + 53603111420421595*q^216 + 48225332557297152*q^217 - 114131789868210811*q^218 + 33191654111905132*q^219 + 129410193071714016*q^220 - 156376856351834512*q^221 - 44658235671454837*q^222 + 250480825842981411*q^223 - 155935640983664877*q^224 - 210459377678531698*q^225 + 396401737596634325*q^226 - 47418193323184856*q^227 - 498942963928549939*q^228 + 494551472021449920*q^229 + 257148955252138125*q^230 - 905357103835774883*q^231 + 416814078348264297*q^232 + 880591390159501485*q^233 - 1322684506378877595*q^234 - 61923611853081540*q^235 + 1878834961435436352*q^236 - 1519854500855452970*q^237 - 1277344661428435146*q^238 + 3160744756204907724*q^239 - 981690025948980442*q^240 - 3502573059955731345*q^241 + 4355579866453570513*q^242 + 1093166717478734146*q^243 - 6867233442684428837*q^244 + 4414938083086532397*q^245 + 5614624392867096209*q^246 - 10906904667519300918*q^247 + 1594880925698936916*q^248 + 13525155530268959593*q^249 - 13771521947713444647*q^250 - 6646298625411416129*q^251 + 24666195023656225220*q^252 - 11954256369127115769*q^253 - 23529547776039222341*q^254 + 36421930891077234251*q^255 + 814761774576192286*q^256 - 50720478467661591293*q^257 + 42332711157259131259*q^258 + 33328231820396404371*q^259 - 86196631632329930193*q^260 + 28529436892239795076*q^261 + 93595020893000721126*q^262 - 119507855555279952938*q^263 - 26207706761245597720*q^264 + 185491012138000875264*q^265 - 123226723029623058639*q^266 - 147846048359101292510*q^267 + 296127195254417919457*q^268 - 50516986996926745555*q^269 - 361497313367660613906*q^270 + 378225296835551409064*q^271 + 169116545706610989271*q^272 - 663820128521632527251*q^273 + 336537626027387812806*q^274 + 620485077927138979418*q^275 - 989475617459647093510*q^276 + 1630929457681723526*q^277 + 1353311727165186516262*q^278 - 1162357715789647971170*q^279 - 858777757848141071799*q^280 + 2320173045245248689806*q^281 - 815727524852589419570*q^282 - 2472430168701471957990*q^283 + 3238471225269316628615*q^284 + 614963397672711769055*q^285 - 4948267667092805082575*q^286 + 3395223868798084755876*q^287 + 3847413544750848102117*q^288 - 7948954903875883119145*q^289 + 1537076071378688306058*q^290 + 9549087853862324839617*q^291 - 10261904693414272882860*q^292 - 4241179692563441147841*q^293 + 17673823074645953309206*q^294 - 9334299452906685146286*q^295 - 16182339813507262122831*q^296 + 26569302900583975043191*q^297 - 668508241089085294164*q^298 - 35735240776065716674728*q^299 + 31538464353584542044882*q^300 + 21888313701974860401348*q^301 - 61760805406933214114225*q^302 + 22981010905468195133332*q^303 + 64643905400886678512757*q^304 - 86828907463871458844781*q^305 - 14087688505019969368679*q^306 + 130614402528089969874236*q^307 - 92472804674633416857648*q^308 - 99067463160631595829819*q^309 + 211264910529121737613368*q^310 - 45430595846208157540104*q^311 - 249729590663752525954431*q^312 + 275466124256794842233636*q^313 + 104938066508680433333047*q^314 - 466101632248672996276943*q^315 + 255724297604387897494351*q^316 + 418018874011789835041278*q^317 - 706264308068623167040516*q^318 + 33976773161683695097696*q^319 + 934917424798956151064316*q^320 - 847080467618343401204651*q^321 - 552426894403143341258226*q^322 + 1628316590423097704136435*q^323 - 638907566692880204493470*q^324 - 1674733654954573458485024*q^325 + 2306525669811470992113298*q^326 + 313601194767967211703577*q^327 - 3416407457582557845761010*q^328 + 2492931783577706508111240*q^329 + 2526874062968547515884800*q^330 - 5565851773804079176821443*q^331 + 1313217463947060963673721*q^332 + 6474413482511372953424447*q^333 - 7325607724660437135773520*q^334 - 2563710480935641602293340*q^335 + 12188633076718987663914788*q^336 - 6932498764594590515115584*q^337 - 10707298784459934254651574*q^338 + 18609278543993205947042875*q^339 - 1311416950097266385005368*q^340 - 24258339367902928369041881*q^341 + 22550218007469306794405084*q^342 + 13816625500345191411651627*q^343 - 42573018630766825281692385*q^344 + 17554990006284822441234564*q^345 + 43033524240949327279882192*q^346 - 60769658169770357225974284*q^347 - 6730718598923377048270129*q^348 + 88651086748797456554029291*q^349 - 66599109810647017422540345*q^350 - 63906988755330032910339183*q^351 + 145491882599523567247840331*q^352 - 37287526132015305960189036*q^353 - 166569587004275626555955827*q^354 + 193214957423600029545569445*q^355 + 61872593761285348632851080*q^356 - 316332817141746782739306734*q^357 + 186216729997909269422728252*q^358 + 272188833427879348622632124*q^359 - 486551672510985468284097992*q^360 + 44894265530906773822526684*q^361 + 624796651305045898972182484*q^362 - 595604160066127739959108933*q^363 - 342645701801591330612781372*q^364 + 1104919635515090706856062384*q^365 - 477359021214088205085387841*q^366 - 1097697039563950302376243726*q^367 + 1589396257559042454799415634*q^368 + 137376784987205841394300402*q^369 - 2284171348838593271120405193*q^370 + 1764947107129534530119074218*q^371 + 1603903428282240391403984522*q^372 - 3776610939548074873081125969*q^373 + 1043132923807842927472204097*q^374 + 4256076899816598893421542159*q^375 - 5059025358152450122494844908*q^376 - 1475275424801237778549676939*q^377 + 8154287222274501681836799245*q^378 - 4961502374641207922090007460*q^379 - 6871822996660832270094424359*q^380 + 12634110472906887585277021753*q^381 - 1434566843965921718680551637*q^382 - 15985775258428414091843620093*q^383 + 15620849630311525184663855948*q^384 + 8429458424448948531290457648*q^385 - 28489057147951629467893378946*q^386 + 12861312973823921527005188266*q^387 + 27815671974152186492189415488*q^388 - 41296893540985120262155455356*q^389 - 2595453184662384898694215873*q^390 + 58482317268964575720609411015*q^391 - 46438510635797320166986489362*q^392 - 39972622257343287427989353653*q^393 + 97415036911332702567616314587*q^394 - 28815052738601898509176252671*q^395 - 108076763718275028363591215450*q^396 + 131601877772248777434595087909*q^397 + 34744406712228586483723551832*q^398 - 208916180639100380313361023272*q^399 + 131232736927886690968347227978*q^400 + 172400664267451584446396709660*q^401 - 326054420845488764476434833266*q^402 + 43806580923173159640600409460*q^403 + 406562910073312381181680494258*q^404 - 407092990050574662312729560104*q^405 - 205785543598960613527641077886*q^406 + 730240877127620280725976995654*q^407 - 343684750504657517880169200473*q^408 - 700642926644767377667411568851*q^409 + 1066643466270105308869488809010*q^410 + 42561726532229710463724986685*q^411 - 1488807700487502365975248495250*q^412 + 1214026570363399797057369410823*q^413 + 989775077100109027833780286058*q^414 - 2498461202332383541244952701100*q^415 + 787285586055761154475364402755*q^416 + 2729031515569603683967834911833*q^417 - 3403387795318378001451789247911*q^418 - 807696175047637937588489098743*q^419 + 5322974895554256857056484534232*q^420 - 3448373486930576321097739494610*q^421 - 4300180354209756212861865293659*q^422 + 8368109702276435980808865144941*q^423 - 1294907119651560243232690785711*q^424 - 10284007524884540910062624191360*q^425 + 10548321412365776551956564167290*q^426 + 4986541029917944055154506276124*q^427 - 18618209976889762083208986787845*q^428 + 9116796185802996853386681256705*q^429 + 17552190006318405975663091930317*q^430 - 27401684154619397768613534176922*q^431 - 480036588275674691757196392440*q^432 + 37704792066325202938210546320623*q^433 - 31553860197972322139884313455539*q^434 - 24360673725547862418866416052249*q^435 + 63748435684344786471655873920245*q^436 - 21303796297773642807077977858575*q^437 - 68556193878794557985452431336884*q^438 + 87549909314795677860771216754949*q^439 + 18512477610410282875793939558328*q^440 - 134943081798507937867151516466369*q^441 + 90072690578676080458233854500087*q^442 + 106684058224862384636613019612023*q^443 - 213687168920110762711793701098010*q^444 + 37345173033189147635594963915067*q^445 + 258848036062008436643626337330139*q^446 - 271892837548582429313480994221051*q^447 - 119955788336040648413786715704595*q^448 + 472389664262624816527569147424296*q^449 - 240240734549578780821184788061973*q^450 - 437508026613426200747927613789036*q^451 + 700485731467745616129092385115958*q^452 - 3056731636338202095782488178942*q^453 - 950368544507652108751246809889792*q^454 + 815797027658505903790111661252874*q^455 + 596173856791562194315009483143098*q^456 - 1618878415593731007819207148807307*q^457 + 571564730633750792484175221587166*q^458 + 1714063043592935608984465062105809*q^459 - 2241301817850930787943306521311471*q^460 - 417597881317529113118037333972729*q^461 + 3405250070048082692415240635537741*q^462 - 2339950825232828322314596970245077*q^463 - 2633514278337959005245323443956749*q^464 + 5431671907844560174925739405555129*q^465 - 1056274786282683926137124896778124*q^466 - 6485653023706512462694380747155547*q^467 + 6974802985555879982658164176574064*q^468 + 2864879460752152757093374932400272*q^469 - 11932511762106299622022792894924326*q^470 + 6292771228891108797284663934330429*q^471 + 10854883672587413647783593952558806*q^472 - 17826526410106608730946763807777772*q^473 + 459821164136638391414491180690425*q^474 + 23850249420884933091643086242764182*q^475 - 20990140830698667169061666597843073*q^476 - 14511358515149849916879933752498342*q^477 + 40933477747619637196315947092369760*q^478 - 15217733462066321761970050438713485*q^479 - 42668293820369073958684966400424714*q^480 + 57124506264668464020982133362589125*q^481 + 9246045962414519999379905250977610*q^482 - 85568345036220481170623677212913969*q^483 + 60485872630491049192448763856819414*q^484 + 64703932004477496516483232784633562*q^485 - 137485625856071076505726710400595540*q^486 + 29405802466059377520816049161292915*q^487 + 161824155402414983882387230928249544*q^488 - 178138026926555863369561468834944272*q^489 - 67926040530545440297197443433554313*q^490 + 300183985335354987366491522398471582*q^491 - 163929973442488514353740860991394635*q^492 - 268157261584312235151730765463053991*q^493 + 451791683973670472840950862501882100*q^494 - 21150955331053435439163816614488414*q^495 - 596136453814927724592833195856812999*q^496 + O(q^497);

// we try to find to express the modular parametrerization in terms of our planar model
// by finding homogeneous polynomials Px, Qx, Py and Qy of degree d1 such that
// Px(f1,f2,f3) + x*Qx(f1,f2,f3)  = 0
// Py(f1,f2,f3) + y*Qy(f1,f2,f3)  = 0
// The following value of d1 was and the precision were found to work experimentally.
// Note that I have no idea what precision will be high enough. However, we can verify that 
// the found polynomials indeed define a map to X_0(p) -> E, which will be enough
// to guarantee the correctness of the computation.
d1 := 15;
prec := 500;
expanded_forms := [qExpansion(f, prec) : f in forms];
monomials := MonomialsOfDegree(R,d1);
time evals := [Evaluate(mon, expanded_forms) : mon in monomials];
evals_x := [f*x : f in evals];
evals_y := [f*y : f in evals];
prec1 := Minimum([Degree(f) : f in evals cat evals_x cat evals_y]);
val := Minimum([Valuation(f) : f in evals cat evals_x cat evals_y]);
print prec1;

Mx := Matrix(Rationals(),[[Coefficient(f,i) : i in [val..prec1]] : f in evals cat evals_x]);
My := Matrix(Rationals(),[[Coefficient(f,i) : i in [val..prec1]] : f in evals cat evals_y]);
assert Rank(Mx) lt #monomials*2;
assert Rank(My) lt #monomials*2;
vx := ClearDenominator(Kernel(Mx).1)[1];
vy := ClearDenominator(Kernel(My).1)[1];
Px := &+[monomials[i]*vx[i] : i in [1..#monomials]];
Qx := &+[monomials[i]*vx[i+#monomials] : i in [1..#monomials]];
Py := &+[monomials[i]*vy[i] : i in [1..#monomials]];
Qy := &+[monomials[i]*vy[i+#monomials] : i in [1..#monomials]];

Rp := ChangeRing(R, GF(p));

Pxp := Rp ! Px;
Qxp := Rp ! Qx;
Pyp := Rp ! Py;
Qyp := Rp ! Qy;

// taken from https://www.lmfdb.org/EllipticCurve/Q/197/a/1
E := EllipticCurve([0, 0, 1, -5, 4]);
Ep := ChangeRing(EllipticCurve(E),GF(p));

// if the following succeeds we actually found a map from X0(p) to E
phi :=  map< C -> E | [-Px/Qx,-Py/Qy,1]>;

// we want the map over F_p
phip :=  map< Cp -> Ep | [-Pxp/Qxp,-Pyp/Qyp,1]>; 

assert Degree(phip) eq 10; //the modular degree according to LMFDB
zero := Ep ! 0;
P := [P : P in Points(Ep) | Order(P) eq 4][1];

D0 := Pullback(phip,Place(P))-Pullback(phip,Place(zero));

divs := Divisors_of_Degree(6,Cp);
print "Nr. of divisors over F_3 to check:", #divs;

todo := [];
for D in Setseq(divs) do
  dim := Dimension(RiemannRochSpace(D[1]+D0));
  if dim gt 0 then
    Append(~todo, D[1]);
  end if;
end for;
print "Nr. of divisors D such that D+D0 in W_6^0:", #todo;


todo2 := [];
for D in todo do
  dims := [Dimension(RiemannRochSpace(D+i*D0)) : i in [1..3]];
  //print dims;
  if 0 notin dims then
     Append(~todo2, D[1]);
  end if;
end for;


print "Nr. of divisors D such that D+i*D0 in W_6^0 for i=1,2,3:", #todo2;
assert #todo2 eq 0;

exit;
